name: Latite Debug

on:
  push:
    branches: ["master"]
    paths:
      - "**.cpp"
      - "**.h"
      - "**.hpp"
      - "**CMakeLists.txt"
      - "**.cmake"
  pull_request:
    branches: ["master"]
    paths:
      - "**.cpp"
      - "**.h"
      - "**.hpp"
      - "**CMakeLists.txt"
      - "**.cmake"
  workflow_dispatch:

env:
  BUILD_CONFIGURATION: Debug
  BUILD_DIR: cmake-build-debug

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up MSVC Developer Environment
        uses: ilammy/msvc-dev-cmd@v1

      - name: Configure CMake
        run: |
          cmake -B ${{ env.BUILD_DIR }} -DCMAKE_BUILD_TYPE=${{ env.BUILD_CONFIGURATION }} -A x64

      - name: Build with CMake
        run: |
          cmake --build ${{ env.BUILD_DIR }} --config ${{ env.BUILD_CONFIGURATION }}

      - name: Rename DLL + PDB
        shell: pwsh
        run: |
          $dll = "${{ github.workspace }}\${{ env.BUILD_DIR }}\Latite.dll"
          $pdb = "${{ github.workspace }}\${{ env.BUILD_DIR }}\Latite.pdb"

          if (Test-Path $dll) {
            Rename-Item -Path $dll -NewName "LatiteDebug.dll" -Force
          } else {
            Write-Error "Latite.dll not found"
            exit 1
          }

          if (Test-Path $pdb) {
            Rename-Item -Path $pdb -NewName "LatiteDebug.pdb" -Force
          }

      - name: Compute build timestamp
        shell: bash
        run: |
          TS=$(date -u +"%Y%m%d-%H%M%S")
          echo "TIMESTAMP=$TS" >> "$GITHUB_ENV"

      - name: Create timestamped archival release
        uses: softprops/action-gh-release@v2.3.2
        with:
          tag_name: debug-${{ env.TIMESTAMP }}
          name: Latite Debug ${{ env.TIMESTAMP }}
          body: |
            ### Automated timestamped debug build

            Built at: ${{ env.TIMESTAMP }} UTC

            Includes:
            - LatiteDebug.dll
            - LatiteDebug.pdb
          prerelease: true
          generate_release_notes: false
          files: |
            ${{ github.workspace }}/cmake-build-debug/LatiteDebug.dll
            ${{ github.workspace }}/cmake-build-debug/LatiteDebug.pdb

      - name: Recreate debug release to refresh date
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release delete debug -y || true
          git push origin :refs/tags/debug || true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2.3.2
        with:
          tag_name: debug
          name: Latite Debug
          body: |
            ### Automated Debug Build (Latest)

            **This debug release may contain bugs or slow performance.**

            Includes:
            - LatiteDebug.dll
            - LatiteDebug.pdb
          prerelease: true
          make_latest: true
          files: |
            ${{ github.workspace }}/cmake-build-debug/LatiteDebug.dll
            ${{ github.workspace }}/cmake-build-debug/LatiteDebug.pdb
